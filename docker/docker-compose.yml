
# =============================================================================
# Reptilia Microservice - Docker Compose
# =============================================================================
#
# RASPBERRY PI DEPLOYMENT (with MongoDB Atlas):
#   cd docker
#   docker-compose --profile ble up -d    # Full stack with BLE support
#
# iPad Monitoring URLs (replace PI_IP with your Pi's IP):
#   Dashboard:  http://PI_IP:8000/api/dashboard
#   API Docs:   http://PI_IP:8000/docs
#   Logs:       http://PI_IP:8000/api/logs/stream
#
# DEVELOPMENT (macOS - no BLE in Docker):
#   docker-compose up -d api              # Start API only (uses Atlas)
#   cd ../service && python main.py       # Run service natively for BLE
#
# LOCAL MONGODB (optional - for offline development):
#   docker-compose --profile local-db up -d mongodb api
#
# For MongoDB web UI (local only, http://localhost:8081):
#   docker-compose --profile local-db --profile tools up -d
#
# Stop services:
#   docker-compose down               # Stop all services
#   docker-compose down -v            # Stop and remove data volumes
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # MongoDB Database (Optional - for local development)
  # ---------------------------------------------------------------------------
  mongodb:
    image: mongo:7.0
    container_name: reptilia-mongodb
    restart: unless-stopped
    profiles:
      - local-db
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    environment:
      MONGO_INITDB_DATABASE: reptilia
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - reptilia-network

  # ---------------------------------------------------------------------------
  # Reptilia API (REST endpoints for iPad monitoring)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: reptilia-api
    restart: unless-stopped
    ports:
      - "8000:8000"
    env_file:
      - ../service/.env
    environment:
      # MONGODB_URI comes from .env file (Atlas connection string)
      MONGODB_DATABASE: ${MONGODB_DATABASE:-reptilia}
      CORS_ORIGINS: '["*"]'
    volumes:
      - reptilia_logs:/app/logs
    networks:
      - reptilia-network

  # ---------------------------------------------------------------------------
  # Reptilia Service (Bridge Network - No BLE, for testing)
  # ---------------------------------------------------------------------------
  service:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: reptilia-service
    restart: unless-stopped
    profiles:
      - no-ble
    env_file:
      - ../service/.env
    environment:
      LOG_FILE: /app/logs/service.log
    volumes:
      - reptilia_logs:/app/logs
    networks:
      - reptilia-network

  # ---------------------------------------------------------------------------
  # Reptilia Service (Host Network - BLE Support for Pi)
  # ---------------------------------------------------------------------------
  # Use: docker-compose --profile ble up -d
  service-ble:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: reptilia-service-ble
    restart: unless-stopped
    profiles:
      - ble
    depends_on:
      api:
        condition: service_started
    env_file:
      - ../service/.env
    environment:
      LOG_FILE: /app/logs/service.log
    volumes:
      - reptilia_logs:/app/logs
      # D-Bus socket required for BlueZ/Bluetooth access
      - /var/run/dbus:/var/run/dbus
    # Required for Bluetooth Low Energy access on Pi
    privileged: true
    network_mode: host

  # ---------------------------------------------------------------------------
  # MongoDB Express (Optional - Web UI for local MongoDB only)
  # ---------------------------------------------------------------------------
  mongo-express:
    image: mongo-express:latest
    container_name: reptilia-mongo-express
    restart: unless-stopped
    profiles:
      - tools
    ports:
      - "8081:8081"
    environment:
      ME_CONFIG_MONGODB_URL: mongodb://mongodb:27017
      ME_CONFIG_BASICAUTH: "false"
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - reptilia-network

# =============================================================================
# Networks
# =============================================================================
networks:
  reptilia-network:
    driver: bridge

# =============================================================================
# Volumes (persistent storage)
# =============================================================================
volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  reptilia_logs:
    driver: local